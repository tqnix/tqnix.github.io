<link rel="icon" type="image/jpeg" href="coloro.jpeg">
   <link rel="icon" type="image/jpeg" href="coloro.jpeg">
   <title>Hare (RIPOFF TURTLE)</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
        font-family: Arial;
        background-color: #303036;
        color: #ffffcd;
        font-size:18px;
        padding:1.5%;
        text-align: left;
        overflow: auto;
    }
    .gau {
      margin: 0;
      padding: 0;
    }
    button {
      font-size: 18px;
    }
    input {
      font-size: 18px;
    }
    canvas {
      right: 0px;
      top: 0px;
      position: absolute;
      pointer-events: none;
    }
    #output {
      overflow-y: auto;
      height: 30vh;
    }
  </style>
    
 <button class="navbutton" onclick="window.open('index.html')">◀️Back</button><br>
 <h1>HARE (turtle ripoff)</h1>
<textarea id=input rows=10 cols=50>
INIT PEN UP GOTO 128 32 ANGLE 90.
TITLE flashing.
POINTER TOGGLE.
PEN TOGGLE.
TURN (360/60).
MOVE 10.
GET pd.

 </textarea>
<div id="magic_mike_fun_box">
</div>
<br>
<button style="font-size: 28px;" onclick="init(); drau(); func_odometer = 0; init(); drau();">RESET</button>
<button style="font-size: 28px;" onclick="parse_text()">RUN</button>
<button style="font-size: 28px;" onclick="toggle_fun_box()">FUNCTIONS & EXAMPLES</button>


<br>
<input type=text id=heoi placeholder="something in ms"></input>
<button onclick="if (s != null) {clearInterval(s);} s = setInterval(parse_text,mafs(document.getElementById('heoi').value))">Auto Iterate (ms)</button>
<button onclick="clearInterval(s)">STOP Auto Iterate</button><br>
<input type="file" id="fileInput" accept=".hare">
<button onclick="save()">Export!</button>

<br>
Toggle: 
<button onclick="toggle_output()">Output</button>
<button onclick="delayflag = !delayflag">Delay</button>
<button onclick="i_am_righteous = !i_am_righteous">Output clearing</button><br>
<br>
<button onclick="window.open('hare_documentation.html')">i actually need help tho</button>
<button onclick="document.getElementById('input').value = '';">CLEAR ALL CODE</button>

<br>
<canvas height=256 width=256 id=art style="border: 1px solid white"></canvas>
<canvas height=256 width=256 id=artf style="border: 1px solid white"></canvas><br><br>
OUTPUT: -------------------------------------------------------------<br>
<div id=output></div>
<script>
  const canvas2 = document.getElementById("artf");
  const ctx2 = canvas2.getContext("2d");
  const canvas = document.getElementById("art");
const ctx = canvas.getContext("2d");
ctx.fillStyle = "#d8e0d0";
ctx.fillRect(0,0,256,256);
generate_fun_box();
var pen = {
  x:128,y:128,th:0,down:true,pointer:true
}
var the = [
  {page:"random",word:0},
  {page:"randomangle",word:0},
  {page:"randominteger",word:0},
];
var qz = "";
var func_odometer = 0;
var waitflag = 100;
var delayflag = false;
var thing_counter = 0;
var MAGIC_MIKE = '.';
var i_am_righteous = false;
var s = null;
/*
INIT 
GOTO 192 64 
VAR test 45 
CLEAR.
PEN UP.
MOVE 1.
PEN DOWN.
TURN test.
REPEAT 5.
THEN MOVE 1.
PEN UP.
MOVE 1.
INC test -1.
PRINT howdy.
*/
function save() {
  //localStorage.savedcode2 = document.getElementById("input").value;
  var inputValue = document.getElementById("input").value;
    var blob = new Blob([inputValue], {type: "text/plain"});
    saveAs(blob, document.title + "_code.hare");
 }
document.getElementById('fileInput').addEventListener('change', function(event) {
  const file = event.target.files[0]; // Get the first selected file

  if (file) {
    const reader = new FileReader();

    reader.onload = function(e) {
      const fileContent = e.target.result; // The content of the text file
      document.getElementById("input").value = e.target.result;
      document.getElementById("output").innerText = "FILE LOADED\n";
      console.log(fileContent);
      // Process the fileContent here
    };

    reader.readAsText(file); // Read the file as text
  }
});
function parse_text() {
 localStorage.savedcode = document.getElementById("output").innerText;
  if (!i_am_righteous) {
    document.getElementById("output").innerText = "";
  }
  qz = document.getElementById("input").value;
   bal = qz.replaceAll("\n","").split(MAGIC_MIKE);
   
    for (var i=0; i<bal.length; i++) {
    bal2 = bal[i].replace(MAGIC_MIKE,'').split(' ');
      turn_that_shit_into_code(parse_line(i),i);
      //document.getElementById("output").innerText += "\n" + "-------------------------\n";
    }
}
function parse_line(f) {
  let outputAsString = "";
    for (var i=0; i<bal2.length; i++) {
      outputAsString += bal2[i] + " | ";
    }
  //document.getElementById("output").innerText += outputAsString;
  //console.log(bal2);
 let b = bal[f].replace(MAGIC_MIKE,'').split(' ');
  return b;
}
function HandleError(lentil,token) {
  let err;
  switch(lentil) {
    case "GENERAL":
      err = "An unspecified error has occurred";
    break;
  }
  err += " | Location: Token" + token;
}
async function turn_that_shit_into_code(arraygoeshere,j) {//j = current line of code
  for (var fjdsa = 0; fjdsa < arraygoeshere.length; fjdsa++) {
      fakevar("px",pen.x,"is");
      fakevar("py",pen.y,"is");
     fakevar("pd",parseFloat(((pen.th*180/Math.PI*-1)%360).toFixed(1)),"is");
      func_odometer++;
      if (waitflag) {
        await new Promise(r => setTimeout(r, waitflag));
        //console.log("books");
        waitflag = 0;
      }
    switch(arraygoeshere[fjdsa]) {
      case "INIT":
        if (func_odometer > 1) {
          fjdsa = 10000;
        } 
      break;
      case "MOVE": 
        move(mafs(arraygoeshere[fjdsa+1]));
        document.getElementById("output").innerText +=("\nMoved " + mafs(arraygoeshere[fjdsa+1]));
      break;
      case "TURN": 
        turn(mafs(arraygoeshere[fjdsa+1]));
        document.getElementById("output").innerText +=("\nTurned " + mafs(arraygoeshere[fjdsa+1]) + " deg.");
      break;
      case "PEN": //subfunction (PEN STYLE, PEN LINE, PEN UP, PEN DOWN, ETC)
        rin(arraygoeshere[fjdsa+1]);
        document.getElementById("output").innerText +=("\nPEN " + arraygoeshere[fjdsa+1] + " DONE");
      break;
      case "POINTER": //subfunction (PEN STYLE, PEN LINE, PEN UP, PEN DOWN, ETC)
        dogitum(arraygoeshere[fjdsa+1]);
        document.getElementById("output").innerText +=("\nPOINTER " + arraygoeshere[fjdsa+1] + " DONE");
      break;
      case "GOTO": 
        goto(mafs(arraygoeshere[fjdsa+1]),mafs(arraygoeshere[fjdsa+2]));
        document.getElementById("output").innerText += ("\nWent to x=" + mafs(arraygoeshere[fjdsa+1]) + ", y=" + mafs(arraygoeshere[fjdsa+2]));
      break;
      case "ANGLE": 
        angle(mafs(arraygoeshere[fjdsa+1]));
        document.getElementById("output").innerText +=("\nTurned " + mafs(arraygoeshere[fjdsa+1]) + " deg.");
      break;
      case "RESET":
      init();
        document.getElementById("output").innerText += ("\nReset!");
      break;
      case "CLEAR":
      pen.fillStyle = "#d8e0d0";
        ctx.fillRect(0,0,256,256);
        document.getElementById("output").innerText += ("\nCanvas Cleared!");
      break;
      case "VAR":
      fakevar(arraygoeshere[fjdsa+1],mafs(arraygoeshere[fjdsa+2]),"is");
        document.getElementById("output").innerText += ("\nVariable " + arraygoeshere[fjdsa+1] + " is now " +arraygoeshere[fjdsa+2]);
      break;
      case "INC":
      fakevar(arraygoeshere[fjdsa+1],mafs(arraygoeshere[fjdsa+2]),"inc");
        document.getElementById("output").innerText += ("\nVariable " + arraygoeshere[fjdsa+1] + " has been increased by " + arraygoeshere[fjdsa+2] + " and now is " + getvar(arraygoeshere[fjdsa+1]));
      break;
      case "GET":
      getvar(arraygoeshere[fjdsa+1]);
        document.getElementById("output").innerText += ("\nVariable " + arraygoeshere[fjdsa+1] + " is " + getvar(arraygoeshere[fjdsa+1]));
      break;
      case "HELP":
      document.getElementById("output").innerText += "\nHelp is bad for the environment";
      break;
      case "THEN": //search for REPEAT, IF, or ELSE (ELSE searches for IF)
      for (a=j; a>=0; a--) {
        let leto = bal[a].split(' ');
        console.log(leto);
        let tengflang = false;
        if (leto[0] == "IF") {
          a = -100;
          switch (leto[2]) {
            case ">": if (mafs(leto[1]) <= mafs(leto[3])) {tengflang = true;} break;
            case "=": if (mafs(leto[1]) !== mafs(leto[3])) {tengflang = true;} break;
            case "<": if (mafs(leto[1]) >= mafs(leto[3])) {tengflang = true;} break;
            case "!=": if (mafs(leto[1]) == mafs(leto[3])) {tengflang = true;} break;
            case "lim": if (mafs(leto[1]) < mafs(leto[3]) || mafs(leto[1]) > mafs(leto[4])) {tengflang = true;} break;
          }
        } else if (leto[0] == "REPEAT") {
          a = -100;
          thing_counter = mafs(leto[1])-1;
        } else if (leto[0] == "UNLESS") {
          a = -100;
          switch (leto[2]) {
            case "<": if (mafs(leto[1]) < mafs(leto[3])) {tengflang = true;} break;
            case "=": if (mafs(leto[1]) == mafs(leto[3])) {tengflang = true;} break;
            case ">": if (mafs(leto[1]) > mafs(leto[3])) {tengflang = true;} break;
            case "!=": if (mafs(leto[1]) !== mafs(leto[3])) {tengflang = true;} break;
            case "lim": if (mafs(leto[1]) > mafs(leto[3]) && mafs(leto[1]) < mafs(leto[4])) {tengflang = true;} break;
          }
        }
        
        if (tengflang) {
          fjdsa = arraygoeshere.length + 16;
          document.getElementById("output").innerText += ("\nVIBE CHECK FAILED ");
        } else if (leto[0] == "IF" || leto[0] == "UNLESS") {
          document.getElementById("output").innerText += ("\nVIBE CHECK PASSED ");
        }
      }
      break;
      case "PRINT":
      document.getElementById("output").innerText += ("\n" + arraygoeshere[fjdsa+1]);
      break;
      case "PRINTMAFS":
      document.getElementById("output").innerText += ("\n" + mafs(arraygoeshere[fjdsa+1]));
      break;
      case "WAIT": //fucked
      waitflag = mafs(arraygoeshere[fjdsa+1]);
      document.getElementById("output").innerText += ("\nSleeping for " + arraygoeshere[fjdsa+1]);
      break;
      case "ASK":
      let glung = prompt(arraygoeshere[fjdsa+1] + " = ? (type \"please stop\" to stop (or you can reload the website)");
      //console.log(glung);
      if (glung == "please stop") {
        reload();
      }
      fakevar(arraygoeshere[fjdsa+1],mafs(glung),"is");
      document.getElementById("output").innerText += ("\nVariable " + arraygoeshere[fjdsa+1] + " is now " + glung);
      break;
      case "CONFIG":
      if (arraygoeshere[fjdsa+1] == "SEMICOLON_TERMINATOR") {
        alert("Javascript injection enabled");
        MAGIC_MIKE = ";";
      }
      if (arraygoeshere[fjdsa+1] == "THE" && arraygoeshere[fjdsa+2] == "CHARACTER" && arraygoeshere[fjdsa+3] == "TERMINATING" && arraygoeshere[fjdsa+4] == "IS") {
        alert("Weirdness Enabled");
        MAGIC_MIKE = arraygoeshere[fjdsa+5];
      }
      break;
      case "TITLE":
      document.title = arraygoeshere[fjdsa+1];
      document.getElementById("output").innerText += ("\nWindow title is now " + arraygoeshere[fjdsa+1]);
      break;
      default:
      break;
      //. works as a ;
    }
    if (fjdsa == arraygoeshere.length -1 && thing_counter > 0) {
      fjdsa = 0;
      thing_counter -= 1;
    }
    if (delayflag) {await sleep(100);}
  }
  drau();
  scrolloutput();
}
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms || 1000));
}
function scrolloutput() {
  ;
  document.getElementById('output').scrollTop = document.getElementById('output').scrollHeight;
}
function drau() {
  ctx2.clearRect(0,0,256,256);
  ctx2.fillStyle = "#404048";
  ctx2.fillRect(pen.x-5,pen.y-5,10,10);
if (pen.down) {
  ctx.lineTo(pen.x,pen.y);
  ctx.stroke();
}
ctx.beginPath();
  ctx.moveTo(pen.x,pen.y);
}
function getvar(pa) {
  if (pa == "random") {
    return Math.random();
  }
  if (pa == "randominteger") {
    return Math.floor(Math.random()*100);
  }
  if (pa == "randomangle") {
    return Math.floor(Math.random()*360);
  }
for (i=0; i<the.length; i++) {
  if (the[i].page == pa) {
    return the[i].word;
  }
}
return "Unable to find";
}
function getvarindex(pa) {
for (i=0; i<the.length; i++) {
  if (the[i].page == pa) {
    return i;
  }
}
return "Unable to find";
}
function fakevar(pa,o,yn) {
  if (getvar(pa) == "Unable to find") {
    the.push({page:pa,word:o});
  } else {
    if (yn == "inc") {
      the[getvarindex(pa)].word += o;
    } else {
      the[getvarindex(pa)].word = o;
    }
  }
  return getvar(pa);
}
function mafs(func) {
  let kayasaki = func;
  let regex = /[A-Za-z]+/i;
  if (func.includes("(")) {
    for (i=0; i<the.length; i++) {
      kayasaki = kayasaki.replaceAll(the[i].page, "getvar('" +the[i].page+ "')");
      console.log(kayasaki);
    }
    return eval(kayasaki);//unsafe af but who cares
  } else if (regex.test(func)) {
    return getvar(func);
  } else if (func.includes(".")) {
    return parseFloat(func);
  } else {
    return parseInt(func);
  } 
}
//Functions to make my programming language work
function init() {
  document.getElementById("output").innerText = "";
  pen.fillStyle = "#d8e0d0";
  ctx.fillRect(0,0,256,256);
 pen = {
  x:128,y:128,th:0,down:true,pointer:false
}
the = [
  {page:"random",word:0},
  {page:"randomangle",word:0},
  {page:"randominteger",word:0},
];
MAGIC_MIKE = ".";
waitflag = 0;
thing_counter = 0;
}
function move(px) {
  drau();//temp
pen.x -= px * Math.sin(pen.th);
pen.y -= px * Math.cos(pen.th);
}
function turn(d) {
  pen.th += -1/180*Math.PI*d;
}
function angle(d) {
  pen.th = -1/180*Math.PI*d;
}
function goto(a,b) {
  pen.x = a;
  pen.y = b;
}
function rin(g) {
  switch (g) {
    case "UP": pen.down = false; break;
    case "DOWN": pen.down = true; break;
    case "TOGGLE": pen.down = !pen.down; break;
    case "WHITE": ctx.strokeColor = "#d8e0d0"; break;
    case "BLACK": ctx.strokeColor = "#404048"; break;
    default: ctx.lineWidth = mafs(g); break;
  }
}
function dogitum(g) {
  switch (g) {
    case "OFF": pen.pointer = false; document.getElementById("artf").style.display = "none"; break;
    case "ON": pen.pointer = true; document.getElementById("artf").style.display = "block"; break;
    case "TOGGLE": pen.pointer = !pen.pointer; toggle_pointer(); break;
    default: ctx.lineWidth = mafs(g); break;
  }
}
function toggle_output() {
   if (document.getElementById("output").style.display == "block") {
      document.getElementById("output").style.display = "none";
   } else {
      document.getElementById("output").style.display = "block";
   }
}
function toggle_pointer() {
   if (document.getElementById("artf").style.display == "block") {
      document.getElementById("artf").style.display = "none";
   } else {
      document.getElementById("artf").style.display = "block";
   }
}
function generate_fun_box() {
  let magic_mike_fun_box_cozy_interior = document.getElementById("magic_mike_fun_box");
  let fun_box_thingies = [
    "INIT",
    "MOVE",
    "GOTO",
    "TURN",
    "ANGLE",
    "CLEAR",
    "RESET",
    "VAR",
    "INC",
    "GET",
    "ASK",
    "px",
    "py",
    "pd",
    "random",
    "randomangle",
    "randominteger",
    "IF",
    "THEN",
    "UNLESS",
    "REPEAT",
    ">",
    "<",
    "=",
    "lim",
    "PRINT",
    "PRINTMAFS",
    "PEN",
    "POINTER",
    "WAIT",
    ".",
  ];
   let fun_box_examples = [
      {"name":"road","data":"INIT PEN UP ANGLE 90 GOTO 2 2.TITLE road.PEN DOWN.REPEAT 40.THEN MOVE 55 TURN 5.PEN UP.GOTO 2 2 ANGLE 90.PEN DOWN.REPEAT 30.THEN MOVE 13 TURN 5.PEN UP.GOTO 2 2 ANGLE 90.PEN DOWN.REPEAT 30.THEN MOVE 15 TURN 5.PEN UP.GOTO 2 2 ANGLE 90.PEN DOWN.REPEAT 30.THEN MOVE 25 TURN 5.PEN UP.GOTO 2 2 ANGLE 90.PEN DOWN.REPEAT 30.THEN MOVE 35 TURN 5.PEN UP.GOTO 2 2 ANGLE 90.PEN DOWN.REPEAT 40.THEN MOVE 45 TURN 5.PEN UP.PRINT halfway_thruuuuu.PEN DOWN.REPEAT 40.THEN PEN TOGGLE MOVE 24 TURN 2.PEN UP.GOTO 2 2 ANGLE 90.PEN DOWN.REPEAT 30.THEN PEN TOGGLE MOVE 20 TURN 5.PEN UP.GOTO 2 2 ANGLE 90.PEN DOWN.REPEAT 30.THEN PEN TOGGLE MOVE 30 TURN 5.PEN UP.GOTO 2 2 ANGLE 90.PEN DOWN.REPEAT 30.THEN PEN TOGGLE MOVE 18 TURN 2.PEN UP.GOTO 2 2 ANGLE 90.PEN DOWN.REPEAT 40.THEN PEN TOGGLE MOVE 23 TURN 2.PEN UP."},
      {"name":"bouncing pointer","data":"INIT ASK a ANGLE a ASK c.VAR b pd.PEN DOWN.PRINTMAFS (b*-1+180).MOVE 8.IF py < 8.THEN ANGLE (b*-1+180) CLEAR.IF py > 248.THEN ANGLE (b*-1+180) CLEAR.IF px < 8.THEN ANGLE (b*-1) CLEAR.IF px > 248.THEN ANGLE (b*-1) CLEAR.UNLESS px lim 0 256.THEN PEN UP GOTO 128 128.UNLESS py lim 0 256.THEN PEN UP GOTO 128 128. POINTER ON. TURN c."},
      {"name":"etch-a-sketch","data":"TITLE etchasketch.ASK move.ANGLE (move*45).IF (move%2) = 0.THEN MOVE 20.IF (move%2) = 1.THEN MOVE (28284/1000)."},
      {"name":"speedtest","data":"TITLE speedtest.VAR c 0.ASK iteration_max.REPEAT iteration_max.THEN INC c 1 PRINTMAFS (c**2).MOVE 32."},
      {"name":"randomly generated art","data":"INIT ASK size POINTER OFF.TITLE art_scalable.MOVE size.ANGLE randomangle.IF px < 0 THEN ANGLE 90.IF px > 256 THEN ANGLE 270.IF py < 0 THEN ANGLE 180.IF py > 256 THEN ANGLE 0."},
   ];
  for (i=0; i<fun_box_thingies.length; i++) {
    magic_mike_fun_box_cozy_interior.innerHTML += "<button onclick='document.getElementById(\"input\").value += \""+fun_box_thingies[i]+" \"'>" + fun_box_thingies[i] + "</button>";
  }
    magic_mike_fun_box_cozy_interior.innerHTML += "<br><br>";
   for (i=0; i<fun_box_examples.length; i++) {
    magic_mike_fun_box_cozy_interior.innerHTML += "<button onclick='document.getElementById(\"input\").value += \""+fun_box_examples[i].data +" \"'>" + fun_box_examples[i].name + "</button>";
  }
}
function toggle_fun_box() {
  if (document.getElementById("magic_mike_fun_box").style.display == "block") {
      document.getElementById("magic_mike_fun_box").style.display = "none";
   } else {
      document.getElementById("magic_mike_fun_box").style.display = "block";
   }
}

//FILESAVER.JS after this

(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define([], factory);
  } else if (typeof exports !== "undefined") {
    factory();
  } else {
    var mod = {
      exports: {}
    };
    factory();
    global.FileSaver = mod.exports;
  }
})(this, function () {
  "use strict";

  /*
  * FileSaver.js
  * A saveAs() FileSaver implementation.
  *
  * By Eli Grey, http://eligrey.com
  *
  * License : https://github.com/eligrey/FileSaver.js/blob/master/LICENSE.md (MIT)
  * source  : http://purl.eligrey.com/github/FileSaver.js
  */
  // The one and only way of getting global scope in all environments
  // https://stackoverflow.com/q/3277182/1008999
  var _global = typeof window === 'object' && window.window === window ? window : typeof self === 'object' && self.self === self ? self : typeof global === 'object' && global.global === global ? global : void 0;

  function bom(blob, opts) {
    if (typeof opts === 'undefined') opts = {
      autoBom: false
    };else if (typeof opts !== 'object') {
      console.warn('Deprecated: Expected third argument to be a object');
      opts = {
        autoBom: !opts
      };
    } // prepend BOM for UTF-8 XML and text/* types (including HTML)
    // note: your browser will automatically convert UTF-16 U+FEFF to EF BB BF

    if (opts.autoBom && /^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(blob.type)) {
      return new Blob([String.fromCharCode(0xFEFF), blob], {
        type: blob.type
      });
    }

    return blob;
  }

  function download(url, name, opts) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url);
    xhr.responseType = 'blob';

    xhr.onload = function () {
      saveAs(xhr.response, name, opts);
    };

    xhr.onerror = function () {
      console.error('could not download file');
    };

    xhr.send();
  }

  function corsEnabled(url) {
    var xhr = new XMLHttpRequest(); // use sync to avoid popup blocker

    xhr.open('HEAD', url, false);

    try {
      xhr.send();
    } catch (e) {}

    return xhr.status >= 200 && xhr.status <= 299;
  } // `a.click()` doesn't work for all browsers (#465)


  function click(node) {
    try {
      node.dispatchEvent(new MouseEvent('click'));
    } catch (e) {
      var evt = document.createEvent('MouseEvents');
      evt.initMouseEvent('click', true, true, window, 0, 0, 0, 80, 20, false, false, false, false, 0, null);
      node.dispatchEvent(evt);
    }
  } // Detect WebView inside a native macOS app by ruling out all browsers
  // We just need to check for 'Safari' because all other browsers (besides Firefox) include that too
  // https://www.whatismybrowser.com/guides/the-latest-user-agent/macos


  var isMacOSWebView = /Macintosh/.test(navigator.userAgent) && /AppleWebKit/.test(navigator.userAgent) && !/Safari/.test(navigator.userAgent);
  var saveAs = _global.saveAs || ( // probably in some web worker
  typeof window !== 'object' || window !== _global ? function saveAs() {}
  /* noop */
  // Use download attribute first if possible (#193 Lumia mobile) unless this is a macOS WebView
  : 'download' in HTMLAnchorElement.prototype && !isMacOSWebView ? function saveAs(blob, name, opts) {
    var URL = _global.URL || _global.webkitURL;
    var a = document.createElement('a');
    name = name || blob.name || 'download';
    a.download = name;
    a.rel = 'noopener'; // tabnabbing
    // TODO: detect chrome extensions & packaged apps
    // a.target = '_blank'

    if (typeof blob === 'string') {
      // Support regular links
      a.href = blob;

      if (a.origin !== location.origin) {
        corsEnabled(a.href) ? download(blob, name, opts) : click(a, a.target = '_blank');
      } else {
        click(a);
      }
    } else {
      // Support blobs
      a.href = URL.createObjectURL(blob);
      setTimeout(function () {
        URL.revokeObjectURL(a.href);
      }, 4E4); // 40s

      setTimeout(function () {
        click(a);
      }, 0);
    }
  } // Use msSaveOrOpenBlob as a second approach
  : 'msSaveOrOpenBlob' in navigator ? function saveAs(blob, name, opts) {
    name = name || blob.name || 'download';

    if (typeof blob === 'string') {
      if (corsEnabled(blob)) {
        download(blob, name, opts);
      } else {
        var a = document.createElement('a');
        a.href = blob;
        a.target = '_blank';
        setTimeout(function () {
          click(a);
        });
      }
    } else {
      navigator.msSaveOrOpenBlob(bom(blob, opts), name);
    }
  } // Fallback to using FileReader and a popup
  : function saveAs(blob, name, opts, popup) {
    // Open a popup immediately do go around popup blocker
    // Mostly only available on user interaction and the fileReader is async so...
    popup = popup || open('', '_blank');

    if (popup) {
      popup.document.title = popup.document.body.innerText = 'downloading...';
    }

    if (typeof blob === 'string') return download(blob, name, opts);
    var force = blob.type === 'application/octet-stream';

    var isSafari = /constructor/i.test(_global.HTMLElement) || _global.safari;

    var isChromeIOS = /CriOS\/[\d]+/.test(navigator.userAgent);

    if ((isChromeIOS || force && isSafari || isMacOSWebView) && typeof FileReader !== 'undefined') {
      // Safari doesn't allow downloading of blob URLs
      var reader = new FileReader();

      reader.onloadend = function () {
        var url = reader.result;
        url = isChromeIOS ? url : url.replace(/^data:[^;]*;/, 'data:attachment/file;');
        if (popup) popup.location.href = url;else location = url;
        popup = null; // reverse-tabnabbing #460
      };

      reader.readAsDataURL(blob);
    } else {
      var URL = _global.URL || _global.webkitURL;
      var url = URL.createObjectURL(blob);
      if (popup) popup.location = url;else location.href = url;
      popup = null; // reverse-tabnabbing #460

      setTimeout(function () {
        URL.revokeObjectURL(url);
      }, 4E4); // 40s
    }
  });
  _global.saveAs = saveAs.saveAs = saveAs;

  if (typeof module !== 'undefined') {
    module.exports = saveAs;
  }
});

</script>
